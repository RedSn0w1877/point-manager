import React, { useState, useEffect, useRef } from 'react';
import { 
  LayoutDashboard, Trophy, CheckSquare, Book, 
  Settings, Power, Wifi, Battery, Cpu, Search, Bell, Menu, X,
  Plus, Trash2, MoreHorizontal, Calendar, Clock, Cloud, 
  Shield, Zap, Crown, Flame, Star, Hexagon, ArrowUpRight,
  ChevronRight, Save, Edit3, Camera, Play, Coins, User,
  Activity, RefreshCw, Smartphone, Terminal
} from 'lucide-react';

// --- ROBUST STORAGE HOOK ---
const useLocalStorage = (key, initialValue) => {
  const [storedValue, setStoredValue] = useState(() => {
    try {
      if (typeof window === 'undefined') return initialValue;
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.error("Storage Error:", error);
      return initialValue;
    }
  });
  const setValue = (value) => {
    try {
      const valueToStore = value instanceof Function ? value(storedValue) : value;
      setStoredValue(valueToStore);
      if (typeof window !== 'undefined') {
        window.localStorage.setItem(key, JSON.stringify(valueToStore));
      }
    } catch (error) {
      console.error("Set Storage Error:", error);
    }
  };
  return [storedValue, setValue];
};

// --- GLOBAL CONSTANTS ---
// Moved outside component to prevent re-render crashes
const TIERS = [
  { name: 'Bronze', min: 0, max: 120, color: 'from-orange-800 to-orange-600', textColor: 'text-orange-500', icon: Shield },
  { name: 'Silver', min: 120, max: 300, color: 'from-slate-400 to-slate-200', textColor: 'text-slate-300', icon: Shield },
  { name: 'Gold', min: 300, max: 600, color: 'from-yellow-600 to-yellow-300', textColor: 'text-yellow-400', icon: Trophy },
  { name: 'Platinum', min: 600, max: 1000, color: 'from-cyan-600 to-cyan-300', textColor: 'text-cyan-400', icon: Crown },
  { name: 'Diamond', min: 1000, max: 5000, color: 'from-indigo-500 via-purple-500 to-pink-500', textColor: 'text-purple-400', icon: Sparkles },
  { name: 'Obsidian', min: 5000, max: 999999999, color: 'from-black via-slate-900 to-slate-800', textColor: 'text-slate-400', icon: Flame },
];

// --- STABLE BACKGROUND ENGINE ---
const StarryBackground = () => {
  const canvasRef = useRef(null);
  
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    // FORCE BLACK BACKGROUND
    canvas.style.background = '#000000';
    
    let animationFrameId;

    const resize = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    };
    window.addEventListener('resize', resize);
    resize();

    const stars = Array.from({ length: 150 }, () => ({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      size: Math.random() * 1.5 + 0.1,
      speedX: (Math.random() - 0.5) * 0.05,
      speedY: (Math.random() - 0.5) * 0.05,
      opacity: Math.random(),
      pulse: Math.random() * 0.02
    }));

    const draw = () => {
      // Use solid black with very slight transparency for trails, but keep base dark
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)'; 
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Nebula Effect (Static-ish to prevent flashing)
      const time = Date.now() * 0.0001;
      const g1 = ctx.createRadialGradient(
        canvas.width * 0.5 + Math.sin(time) * 100, 
        canvas.height * 0.5 + Math.cos(time) * 100, 
        0, 
        canvas.width * 0.5, 
        canvas.height * 0.5, 
        800
      );
      g1.addColorStop(0, 'rgba(76, 29, 149, 0.05)'); // Very subtle purple
      g1.addColorStop(1, 'transparent');
      ctx.fillStyle = g1;
      ctx.fillRect(0,0,canvas.width,canvas.height);

      stars.forEach(star => {
        star.x += star.speedX;
        star.y += star.speedY;
        star.opacity += star.pulse;
        if (star.opacity > 1 || star.opacity < 0.2) star.pulse = -star.pulse;
        
        if(star.x<0) star.x=canvas.width;
        if(star.x>canvas.width) star.x=0;
        if(star.y<0) star.y=canvas.height;
        if(star.y>canvas.height) star.y=0;

        ctx.beginPath();
        ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
        ctx.fill();
      });
      animationFrameId = requestAnimationFrame(draw);
    };
    draw();
    return () => {
      window.removeEventListener('resize', resize);
      cancelAnimationFrame(animationFrameId);
    };
  }, []);
  
  // Explicit inline style for background color to prevent white flash
  return <canvas ref={canvasRef} className="fixed inset-0 z-0 pointer-events-none" style={{ backgroundColor: '#000000' }} />;
};

// --- MODULE: COMMAND DECK ---
const Dashboard = ({ users, energy, recharge }) => {
  const [time, setTime] = useState(new Date());
  const [focus, setFocus] = useLocalStorage('nexus_focus', '');
  const [cpuLoad, setCpuLoad] = useState(12);

  useEffect(() => {
    const timer = setInterval(() => setTime(new Date()), 1000);
    const cpuTimer = setInterval(() => {
      setCpuLoad(prev => Math.min(100, Math.max(5, prev + (Math.random() - 0.5) * 15)));
    }, 2000);
    return () => { clearInterval(timer); clearInterval(cpuTimer); };
  }, []);

  const totalPoints = users ? users.reduce((acc, curr) => acc + (curr.points || 0), 0) : 0;

  const getEnergyStatus = () => {
    if (energy > 60) return { text: 'OPTIMAL', color: 'text-emerald-400', bar: 'bg-emerald-500' };
    if (energy > 20) return { text: 'DRAINING', color: 'text-yellow-400', bar: 'bg-yellow-500' };
    return { text: 'CRITICAL', color: 'text-rose-500 animate-pulse', bar: 'bg-rose-500' };
  };

  const status = getEnergyStatus();

  return (
    <div className="space-y-6 animate-slide-up pb-20">
      <div className="relative overflow-hidden rounded-[2rem] bg-[#0a0a0a] border border-white/10 p-8 md:p-12 shadow-2xl backdrop-blur-md group">
        <div className="absolute inset-0 bg-gradient-to-br from-indigo-900/20 via-black to-black opacity-80"></div>
        <div className="absolute top-[-50px] right-[-50px] opacity-10 pointer-events-none group-hover:rotate-[360deg] transition-transform duration-[40s]">
          <Hexagon size={300} className="text-white" strokeWidth={0.5} />
        </div>
        
        <div className="relative z-10 flex flex-col md:flex-row justify-between items-end gap-6">
          <div>
            <h2 className="text-xs font-mono text-indigo-400 tracking-[0.3em] mb-2 flex items-center gap-2">
              <span className={`w-2 h-2 rounded-full ${energy > 0 ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></span>
              SYSTEM_V4.1
            </h2>
            <h1 className="text-5xl md:text-7xl font-black text-white mb-2 tracking-tighter">
              {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
            </h1>
            <p className="text-slate-400 text-lg font-light tracking-wide">
              {time.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' })}
            </p>
          </div>
          
          <div className="text-right hidden md:block">
            <div className="text-xl font-bold text-white flex items-center justify-end gap-2">
              <span className="text-indigo-400"><Smartphone size={18}/></span> Sharon, MA
            </div>
            <div className="text-sm text-slate-400">68°F • Clear Sky</div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="md:col-span-2 bg-[#080808]/80 border border-white/5 rounded-3xl p-6 backdrop-blur-md hover:border-indigo-500/30 transition-all group">
          <h3 className="text-slate-500 font-bold uppercase tracking-wider text-[10px] mb-4 flex items-center gap-2">
            <Star size={14} className="text-yellow-500" /> Primary Directive
          </h3>
          <input 
            type="text" 
            value={focus}
            onChange={(e) => setFocus(e.target.value)}
            placeholder="Enter mission..."
            className="w-full bg-transparent text-2xl md:text-3xl font-bold text-white placeholder-white/10 outline-none border-b border-white/10 focus:border-indigo-500 transition-all pb-4 tracking-tight"
          />
        </div>

        <div className="bg-[#080808]/80 border border-white/5 rounded-3xl p-6 backdrop-blur-md flex flex-col justify-between relative overflow-hidden group">
          <div className="flex justify-between items-start relative z-10">
            <h3 className="text-slate-500 font-bold uppercase tracking-wider text-[10px] flex items-center gap-2">
              <Zap size={14} className={status.color} /> Energy Core
            </h3>
            <span className={`text-[10px] font-mono font-bold ${status.color}`}>{status.text}</span>
          </div>

          <div className="flex-1 flex items-center justify-center my-4 relative z-10">
            <div className="text-5xl font-black font-mono tracking-tighter text-white">
               {Math.floor(energy)}<span className="text-xl text-slate-500">%</span>
            </div>
          </div>

          <button 
            onClick={recharge}
            className="relative z-10 w-full bg-white/5 hover:bg-white/10 border border-white/10 text-white py-3 rounded-xl text-xs font-bold tracking-widest uppercase transition-all active:scale-95 flex items-center justify-center gap-2"
          >
            <RefreshCw size={14} className={energy < 100 ? "animate-spin-slow" : ""} /> Recharge
          </button>
          
          <div className="absolute bottom-0 left-0 h-1 bg-white/10 w-full">
            <div className={`h-full transition-all duration-500 ${status.bar}`} style={{ width: `${energy}%` }}></div>
          </div>
        </div>
      </div>

       <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
         <div className="bg-[#0a0a0a]/60 border border-white/5 rounded-2xl p-4 flex flex-col items-center justify-center text-center">
           <Cpu className="text-purple-400 mb-2" size={20} />
           <span className="text-xl font-bold text-white font-mono">{Math.round(cpuLoad)}%</span>
           <span className="text-[10px] text-slate-500 uppercase tracking-wider mt-1">CPU Load</span>
         </div>
         <div className="bg-[#0a0a0a]/60 border border-white/5 rounded-2xl p-4 flex flex-col items-center justify-center text-center">
           <Coins className="text-yellow-400 mb-2" size={20} />
           <span className="text-xl font-bold text-white font-mono">{totalPoints.toLocaleString()}</span>
           <span className="text-[10px] text-slate-500 uppercase tracking-wider mt-1">Total FP</span>
         </div>
         <div className="bg-[#0a0a0a]/60 border border-white/5 rounded-2xl p-4 flex flex-col items-center justify-center text-center">
           <Wifi className="text-cyan-400 mb-2" size={20} />
           <span className="text-xl font-bold text-white font-mono">1.2G</span>
           <span className="text-[10px] text-slate-500 uppercase tracking-wider mt-1">Uplink</span>
         </div>
         <div className="bg-[#0a0a0a]/60 border border-white/5 rounded-2xl p-4 flex flex-col items-center justify-center text-center">
           <Shield className="text-emerald-400 mb-2" size={20} />
           <span className="text-xl font-bold text-white font-mono">SECURE</span>
           <span className="text-[10px] text-slate-500 uppercase tracking-wider mt-1">Firewall</span>
         </div>
      </div>
    </div>
  );
};

// --- MODULE: POINTS MANAGER (CRASH FIXED) ---
const PointsManager = ({ users = [], addUser, modifyPoints, deleteUser }) => {
  const [input, setInput] = useState('');

  const handleAdd = (e) => {
    e.preventDefault();
    if(input) { addUser(input); setInput(''); }
  };

  return (
    <div className="animate-fade-in space-y-8 pb-20">
      <div className="flex flex-col md:flex-row justify-between items-end border-b border-white/10 pb-6 gap-4">
        <div>
           <h2 className="text-4xl font-black text-white tracking-tighter mb-2">POINTS MANAGER</h2>
           <p className="text-slate-400 text-sm font-medium flex items-center gap-2">
             <span className="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span> Database Active
           </p>
        </div>
        <form onSubmit={handleAdd} className="flex gap-2 w-full md:w-auto">
           <input 
              value={input} 
              onChange={e => setInput(e.target.value)} 
              placeholder="Initialize User..." 
              className="w-full md:w-64 bg-[#0a0a0a] border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 text-sm placeholder-slate-600 font-mono transition-all" 
           />
           <button className="bg-white/10 hover:bg-indigo-600 px-4 py-2 rounded-xl text-white transition-all">
             <Plus size={20}/>
           </button>
        </form>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {users.map(u => {
          // SAFE TIER CALCULATION
          const safePoints = u.points || 0;
          const tier = TIERS.find(t => safePoints >= t.min && safePoints < t.max) || TIERS[TIERS.length - 1];
          const TierIcon = tier.icon;
          const nextTier = TIERS[TIERS.indexOf(tier) + 1];
          
          let progress = 100;
          if (nextTier) {
            progress = ((safePoints - tier.min) / (nextTier.min - tier.min)) * 100;
            progress = Math.min(100, Math.max(0, progress)); // Clamp between 0-100
          }
          
          return (
            <div key={u.id} className="group relative bg-[#0a0a0a]/90 border border-white/10 p-6 rounded-[1.5rem] overflow-hidden hover:border-white/20 transition-all hover:shadow-2xl hover:-translate-y-1 backdrop-blur-xl">
              {/* Dynamic Glow Background */}
              <div className={`absolute -right-10 -top-10 w-40 h-40 bg-gradient-to-br ${tier.color} opacity-5 blur-[60px] rounded-full group-hover:opacity-10 transition-all duration-700`}></div>
              
              <div className="flex justify-between items-start mb-6 relative z-10">
                 <div className="flex items-center gap-4">
                    <div className={`w-14 h-14 rounded-2xl bg-gradient-to-br ${tier.color} flex items-center justify-center shadow-lg text-white ring-1 ring-white/10`}>
                       <TierIcon size={24} className="drop-shadow-md" />
                    </div>
                    <div>
                       <h3 className="font-bold text-white text-xl leading-none mb-1">{u.name}</h3>
                       <span className={`text-[10px] font-black uppercase tracking-[0.2em] ${tier.textColor}`}>
                         {tier.name}
                       </span>
                    </div>
                 </div>
                 <div className="text-right">
                    <h2 className="text-3xl font-mono font-black text-white tracking-tighter">{safePoints.toLocaleString()}</h2>
                    <span className="text-[10px] text-slate-500 font-bold tracking-widest uppercase">FP Val</span>
                 </div>
              </div>
              
              <div className="relative h-3 bg-black rounded-full overflow-hidden mb-6 border border-white/5">
                 <div className={`absolute top-0 left-0 h-full bg-gradient-to-r ${tier.color} transition-all duration-1000 ease-out`} style={{ width: `${progress}%` }}>
                    <div className="absolute inset-0 bg-white/20 animate-pulse"></div>
                 </div>
              </div>

              <div className="flex gap-3">
                 <button onClick={() => modifyPoints(u.id, 50)} className="flex-1 bg-white/5 hover:bg-emerald-500/10 hover:text-emerald-400 hover:border-emerald-500/30 border border-white/5 py-3 rounded-xl text-xs font-mono font-bold transition-all active:scale-95 flex items-center justify-center gap-1">
                   <ArrowUpRight size={12}/> +50
                 </button>
                 <button onClick={() => modifyPoints(u.id, -50)} className="flex-1 bg-white/5 hover:bg-rose-500/10 hover:text-rose-400 hover:border-rose-500/30 border border-white/5 py-3 rounded-xl text-xs font-mono font-bold transition-all active:scale-95">
                   -50
                 </button>
                 <button onClick={() => deleteUser(u.id)} className="px-4 bg-white/5 hover:bg-red-500/20 text-slate-500 hover:text-red-500 rounded-xl border border-white/5 hover:border-red-500/30 transition-colors">
                   <Trash2 size={16}/>
                 </button>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

// --- MODULE: QUEST LOG ---
const QuestLog = ({ tasks = [], addTask, completeTask, deleteTask, users = [] }) => {
  const [newTask, setNewTask] = useState('');
  const [reward, setReward] = useState(50);
  const [targetUser, setTargetUser] = useState(users[0]?.id || '');

  useEffect(() => {
    if (!targetUser && users.length > 0) setTargetUser(users[0].id);
  }, [users, targetUser]);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!newTask.trim()) return;
    if (!targetUser) { alert("Assignee required (No cap)"); return; }
    addTask(newTask, parseInt(reward), parseInt(targetUser));
    setNewTask('');
  };

  return (
    <div className="animate-slide-up h-full flex flex-col pb-20">
      <div className="mb-8">
        <h2 className="text-4xl font-black text-white flex items-center gap-3 mb-2 tracking-tighter">
           QUEST LOG
        </h2>
        <p className="text-slate-400 text-sm">Secure the bag. Complete objectives.</p>
      </div>

      <form onSubmit={handleSubmit} className="mb-8 bg-[#0a0a0a]/80 border border-white/10 p-5 rounded-[1.5rem] flex flex-col md:flex-row gap-4 shadow-xl backdrop-blur-sm">
         <div className="flex-1">
            <label className="text-[10px] text-slate-500 font-mono uppercase font-bold pl-1 mb-2 block">Mission Brief</label>
            <input 
              value={newTask}
              onChange={(e) => setNewTask(e.target.value)}
              placeholder="Deploy code, Touch grass..."
              className="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-green-500 transition-all placeholder-slate-600 font-medium"
            />
         </div>
         
         <div className="w-28">
            <label className="text-[10px] text-slate-500 font-mono uppercase font-bold pl-1 mb-2 block">Bounty (FP)</label>
            <input 
              type="number"
              value={reward}
              onChange={(e) => setReward(e.target.value)}
              className="w-full bg-black/50 border border-white/10 rounded-xl px-3 py-3 text-white outline-none focus:border-green-500 transition-all font-mono text-center font-bold"
            />
         </div>

         <div className="md:w-56">
             <label className="text-[10px] text-slate-500 font-mono uppercase font-bold pl-1 mb-2 block">Assignee</label>
             <div className="relative">
               <select 
                  value={targetUser}
                  onChange={(e) => setTargetUser(e.target.value)}
                  className="w-full bg-black/50 border border-white/10 rounded-xl px-3 py-3 text-white outline-none focus:border-green-500 transition-all appearance-none cursor-pointer"
               >
                  {users.map(u => <option key={u.id} value={u.id} className="bg-black">{u.name}</option>)}
               </select>
               <div className="absolute right-3 top-3.5 pointer-events-none text-slate-500"><User size={14}/></div>
             </div>
         </div>

         <div className="flex items-end">
            <button className="bg-green-600 hover:bg-green-500 text-black font-bold h-[48px] px-8 rounded-xl transition-all active:scale-95 flex items-center gap-2 shadow-[0_0
